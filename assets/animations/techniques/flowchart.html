<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>フローチャートアニメーション - システム処理フロー</title>
    <link rel="stylesheet" href="../styles/animations.css">
    <link rel="stylesheet" href="../styles/charts.css">
</head>
<body>
    <div class="animation-container">
        <h2 class="chart-title">ユーザー登録システム処理フロー</h2>
        
        <div class="chart-area">
            <svg width="800" height="600" viewBox="0 0 800 600" id="flowchart" style="width: 100%; height: auto; max-height: 600px;">
                <!-- Definitions for gradients and markers -->
                <defs>
                    <linearGradient id="startGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#4ECDC4;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#44A08D;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="processGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#45B7D1;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#1E3A8A;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="decisionGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#FECA57;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#F39C12;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="endGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#96CEB4;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#27AE60;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="errorGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#FF6B6B;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#E74C3C;stop-opacity:1" />
                    </linearGradient>
                    
                    <!-- Arrow marker -->
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
                    </marker>
                </defs>
                
                <!-- Start Node -->
                <g class="flow-node" id="node-start" opacity="0">
                    <ellipse cx="400" cy="50" rx="80" ry="30" fill="url(#startGradient)" stroke="white" stroke-width="3"/>
                    <text x="400" y="55" text-anchor="middle" fill="white" font-size="14" font-weight="600">開始</text>
                </g>
                
                <!-- User Input Node -->
                <g class="flow-node" id="node-input" opacity="0">
                    <rect x="320" y="120" width="160" height="60" rx="10" fill="url(#processGradient)" stroke="white" stroke-width="3"/>
                    <text x="400" y="140" text-anchor="middle" fill="white" font-size="12" font-weight="600">ユーザー情報入力</text>
                    <text x="400" y="160" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="10">名前、メール、パスワード</text>
                </g>
                
                <!-- Validation Decision Node -->
                <g class="flow-node" id="node-validation" opacity="0">
                    <polygon points="400,220 340,250 400,280 460,250" fill="url(#decisionGradient)" stroke="white" stroke-width="3"/>
                    <text x="400" y="245" text-anchor="middle" fill="white" font-size="11" font-weight="600">入力検証</text>
                    <text x="400" y="260" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="9">フォーマット確認</text>
                </g>
                
                <!-- Error Node -->
                <g class="flow-node" id="node-error" opacity="0">
                    <rect x="120" y="220" width="140" height="60" rx="10" fill="url(#errorGradient)" stroke="white" stroke-width="3"/>
                    <text x="190" y="240" text-anchor="middle" fill="white" font-size="12" font-weight="600">エラー表示</text>
                    <text x="190" y="260" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="10">再入力を促す</text>
                </g>
                
                <!-- Database Check Decision -->
                <g class="flow-node" id="node-dbcheck" opacity="0">
                    <polygon points="400,340 340,370 400,400 460,370" fill="url(#decisionGradient)" stroke="white" stroke-width="3"/>
                    <text x="400" y="365" text-anchor="middle" fill="white" font-size="11" font-weight="600">重複チェック</text>
                    <text x="400" y="380" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="9">メール存在確認</text>
                </g>
                
                <!-- Duplicate Error Node -->
                <g class="flow-node" id="node-duplicate" opacity="0">
                    <rect x="540" y="340" width="140" height="60" rx="10" fill="url(#errorGradient)" stroke="white" stroke-width="3"/>
                    <text x="610" y="360" text-anchor="middle" fill="white" font-size="12" font-weight="600">重複エラー</text>
                    <text x="610" y="380" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="10">別のメールで再試行</text>
                </g>
                
                <!-- Save to Database -->
                <g class="flow-node" id="node-save" opacity="0">
                    <rect x="320" y="460" width="160" height="60" rx="10" fill="url(#processGradient)" stroke="white" stroke-width="3"/>
                    <text x="400" y="480" text-anchor="middle" fill="white" font-size="12" font-weight="600">データベース保存</text>
                    <text x="400" y="500" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-size="10">ユーザー情報登録</text>
                </g>
                
                <!-- Success Node -->
                <g class="flow-node" id="node-success" opacity="0">
                    <ellipse cx="400" cy="570" rx="80" ry="30" fill="url(#endGradient)" stroke="white" stroke-width="3"/>
                    <text x="400" y="575" text-anchor="middle" fill="white" font-size="14" font-weight="600">登録完了</text>
                </g>
                
                <!-- Arrows -->
                <g class="flow-arrows">
                    <!-- Start to Input -->
                    <line id="arrow-1" x1="400" y1="80" x2="400" y2="120" stroke="#666" stroke-width="3" marker-end="url(#arrowhead)" opacity="0"/>
                    
                    <!-- Input to Validation -->
                    <line id="arrow-2" x1="400" y1="180" x2="400" y2="220" stroke="#666" stroke-width="3" marker-end="url(#arrowhead)" opacity="0"/>
                    
                    <!-- Validation to Error (No) -->
                    <path id="arrow-3" d="M 340 250 L 260 250" stroke="#e74c3c" stroke-width="3" marker-end="url(#arrowhead)" opacity="0"/>
                    <text x="300" y="245" text-anchor="middle" fill="#e74c3c" font-size="12" font-weight="600" opacity="0" id="no-text-1">No</text>
                    
                    <!-- Error back to Input -->
                    <path id="arrow-4" d="M 190 220 L 190 150 L 320 150" stroke="#e74c3c" stroke-width="3" marker-end="url(#arrowhead)" opacity="0" stroke-dasharray="5,5"/>
                    
                    <!-- Validation to DB Check (Yes) -->
                    <line id="arrow-5" x1="400" y1="280" x2="400" y2="340" stroke="#27ae60" stroke-width="3" marker-end="url(#arrowhead)" opacity="0"/>
                    <text x="420" y="315" text-anchor="middle" fill="#27ae60" font-size="12" font-weight="600" opacity="0" id="yes-text-1">Yes</text>
                    
                    <!-- DB Check to Duplicate (Exists) -->
                    <path id="arrow-6" d="M 460 370 L 540 370" stroke="#e74c3c" stroke-width="3" marker-end="url(#arrowhead)" opacity="0"/>
                    <text x="500" y="365" text-anchor="middle" fill="#e74c3c" font-size="12" font-weight="600" opacity="0" id="exists-text">Exists</text>
                    
                    <!-- Duplicate back to Input -->
                    <path id="arrow-7" d="M 610 340 L 610 150 L 480 150" stroke="#e74c3c" stroke-width="3" marker-end="url(#arrowhead)" opacity="0" stroke-dasharray="5,5"/>
                    
                    <!-- DB Check to Save (New) -->
                    <line id="arrow-8" x1="400" y1="400" x2="400" y2="460" stroke="#27ae60" stroke-width="3" marker-end="url(#arrowhead)" opacity="0"/>
                    <text x="420" y="435" text-anchor="middle" fill="#27ae60" font-size="12" font-weight="600" opacity="0" id="new-text">New</text>
                    
                    <!-- Save to Success -->
                    <line id="arrow-9" x1="400" y1="520" x2="400" y2="540" stroke="#666" stroke-width="3" marker-end="url(#arrowhead)" opacity="0"/>
                </g>
                
                <!-- Status indicator -->
                <g id="status-indicator" opacity="0">
                    <rect x="20" y="20" width="200" height="80" rx="10" fill="rgba(255, 255, 255, 0.95)" stroke="#e0e0e0" stroke-width="1"/>
                    <text x="30" y="40" font-size="12" font-weight="600" fill="#2c3e50">処理状況</text>
                    <text x="30" y="60" font-size="14" font-weight="700" fill="#667eea" id="status-text">待機中...</text>
                    <circle id="status-dot" cx="200" cy="70" r="6" fill="#95a5a6"/>
                </g>
                
            </svg>
        </div>
        
        <div class="control-panel">
            <button class="control-btn" id="playBtn" onclick="playAnimation()">再生</button>
            <button class="control-btn pause" id="pauseBtn" onclick="pauseAnimation()">一時停止</button>
            <button class="control-btn reset" id="resetBtn" onclick="resetAnimation()">リセット</button>
            <div class="speed-control">
                <label for="speedSelect">速度:</label>
                <select id="speedSelect" onchange="changeSpeed()">
                    <option value="0.5">0.5x</option>
                    <option value="1" selected>1x</option>
                    <option value="1.5">1.5x</option>
                    <option value="2">2x</option>
                </select>
            </div>
        </div>
    </div>

    <script>
        // Animation sequence data
        const animationSequence = [
            { 
                elements: ['node-start'], 
                status: 'システム開始',
                color: '#4ECDC4'
            },
            { 
                elements: ['arrow-1'], 
                status: '入力画面表示',
                color: '#45B7D1'
            },
            { 
                elements: ['node-input'], 
                status: 'ユーザー情報入力中',
                color: '#45B7D1'
            },
            { 
                elements: ['arrow-2'], 
                status: '入力検証開始',
                color: '#FECA57'
            },
            { 
                elements: ['node-validation'], 
                status: 'フォーマット検証中',
                color: '#FECA57'
            },
            { 
                elements: ['arrow-3', 'no-text-1'], 
                status: '入力エラー検出',
                color: '#FF6B6B'
            },
            { 
                elements: ['node-error'], 
                status: 'エラーメッセージ表示',
                color: '#FF6B6B'
            },
            { 
                elements: ['arrow-4'], 
                status: '再入力要求',
                color: '#FF6B6B'
            },
            { 
                elements: ['arrow-5', 'yes-text-1'], 
                status: '検証成功 - DB確認へ',
                color: '#27AE60'
            },
            { 
                elements: ['node-dbcheck'], 
                status: 'データベース重複チェック',
                color: '#FECA57'
            },
            { 
                elements: ['arrow-6', 'exists-text'], 
                status: '重複メール検出',
                color: '#FF6B6B'
            },
            { 
                elements: ['node-duplicate'], 
                status: '重複エラー表示',
                color: '#FF6B6B'
            },
            { 
                elements: ['arrow-7'], 
                status: '再入力要求（重複）',
                color: '#FF6B6B'
            },
            { 
                elements: ['arrow-8', 'new-text'], 
                status: '新規ユーザー - 保存開始',
                color: '#27AE60'
            },
            { 
                elements: ['node-save'], 
                status: 'データベース保存中',
                color: '#45B7D1'
            },
            { 
                elements: ['arrow-9'], 
                status: '保存完了',
                color: '#96CEB4'
            },
            { 
                elements: ['node-success'], 
                status: '登録完了！',
                color: '#96CEB4'
            }
        ];

        let animationSpeed = 1;
        let isPlaying = false;
        let currentStep = 0;
        let animationTimeout;

        function updateStatus(text, color) {
            const statusText = document.getElementById('status-text');
            const statusDot = document.getElementById('status-dot');
            const statusIndicator = document.getElementById('status-indicator');
            
            statusIndicator.style.opacity = '1';
            statusText.textContent = text;
            statusText.style.fill = color;
            statusDot.style.fill = color;
            
            // Add pulse animation to status dot
            statusDot.style.animation = `pulse ${0.8 / animationSpeed}s ease-in-out infinite`;
        }

        function animateElement(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            // For nodes, add scale animation
            if (elementId.startsWith('node-')) {
                element.style.transform = 'scale(0.8)';
                element.style.transformOrigin = 'center';
                element.style.transition = `all ${0.5 / animationSpeed}s cubic-bezier(0.16, 1, 0.3, 1)`;
                
                setTimeout(() => {
                    element.style.opacity = '1';
                    element.style.transform = 'scale(1)';
                    
                    // Add bounce effect
                    setTimeout(() => {
                        element.style.transform = 'scale(1.05)';
                        setTimeout(() => {
                            element.style.transform = 'scale(1)';
                        }, 150 / animationSpeed);
                    }, 300 / animationSpeed);
                }, 50);
                
            } 
            // For arrows, add drawing animation
            else if (elementId.startsWith('arrow-')) {
                const pathLength = element.getTotalLength ? element.getTotalLength() : 100;
                
                if (element.tagName === 'path' || element.tagName === 'line') {
                    element.style.strokeDasharray = pathLength;
                    element.style.strokeDashoffset = pathLength;
                    element.style.transition = `stroke-dashoffset ${0.8 / animationSpeed}s ease-out`;
                }
                
                element.style.opacity = '1';
                
                setTimeout(() => {
                    if (element.tagName === 'path' || element.tagName === 'line') {
                        element.style.strokeDashoffset = '0';
                    }
                }, 50);
            }
            // For text elements
            else {
                element.style.transition = `opacity ${0.3 / animationSpeed}s ease-out`;
                element.style.opacity = '1';
            }
        }

        function playAnimation() {
            if (isPlaying) return;
            
            isPlaying = true;
            document.getElementById('playBtn').style.opacity = '0.5';
            
            currentStep = 0;
            animateSequence();
        }

        function animateSequence() {
            if (currentStep >= animationSequence.length || !isPlaying) {
                isPlaying = false;
                document.getElementById('playBtn').style.opacity = '1';
                
                // Final status update
                setTimeout(() => {
                    updateStatus('アニメーション完了', '#27AE60');
                    const statusDot = document.getElementById('status-dot');
                    statusDot.style.animation = 'none';
                }, 500);
                
                return;
            }
            
            const step = animationSequence[currentStep];
            
            // Update status
            updateStatus(step.status, step.color);
            
            // Animate elements in this step
            step.elements.forEach((elementId, index) => {
                setTimeout(() => {
                    animateElement(elementId);
                }, index * 100 / animationSpeed);
            });
            
            // Add highlight effect to active nodes
            if (step.elements[0].startsWith('node-')) {
                const node = document.getElementById(step.elements[0]);
                node.style.filter = 'drop-shadow(0 0 20px rgba(255, 255, 255, 0.8))';
                
                setTimeout(() => {
                    node.style.filter = 'none';
                }, 1000 / animationSpeed);
            }
            
            // Move to next step
            currentStep++;
            animationTimeout = setTimeout(() => {
                animateSequence();
            }, 1200 / animationSpeed);
        }

        function pauseAnimation() {
            isPlaying = false;
            clearTimeout(animationTimeout);
            document.getElementById('playBtn').style.opacity = '1';
            
            const statusDot = document.getElementById('status-dot');
            statusDot.style.animation = 'none';
            updateStatus('一時停止中', '#F39C12');
        }

        function resetAnimation() {
            pauseAnimation();
            currentStep = 0;
            
            // Reset all nodes
            const nodes = document.querySelectorAll('.flow-node');
            nodes.forEach(node => {
                node.style.opacity = '0';
                node.style.transform = 'scale(0.8)';
                node.style.transition = 'none';
                node.style.filter = 'none';
            });
            
            // Reset all arrows
            const arrows = document.querySelectorAll('.flow-arrows line, .flow-arrows path');
            arrows.forEach(arrow => {
                arrow.style.opacity = '0';
                arrow.style.strokeDasharray = '';
                arrow.style.strokeDashoffset = '';
                arrow.style.transition = 'none';
            });
            
            // Reset all text labels
            const texts = document.querySelectorAll('#no-text-1, #yes-text-1, #exists-text, #new-text');
            texts.forEach(text => {
                text.style.opacity = '0';
                text.style.transition = 'none';
            });
            
            // Reset status
            const statusIndicator = document.getElementById('status-indicator');
            statusIndicator.style.opacity = '0';
            const statusDot = document.getElementById('status-dot');
            statusDot.style.animation = 'none';
        }

        function changeSpeed() {
            animationSpeed = parseFloat(document.getElementById('speedSelect').value);
        }

        // Add interactive hover effects to nodes
        function addInteractiveEffects() {
            const nodes = document.querySelectorAll('.flow-node');
            
            nodes.forEach(node => {
                node.addEventListener('mouseenter', () => {
                    if (!isPlaying) {
                        node.style.filter = 'drop-shadow(0 0 15px rgba(102, 126, 234, 0.6))';
                        node.style.cursor = 'pointer';
                        
                        // Show tooltip with node information
                        const tooltip = createTooltip(node);
                        if (tooltip) {
                            document.body.appendChild(tooltip);
                        }
                    }
                });
                
                node.addEventListener('mouseleave', () => {
                    if (!isPlaying) {
                        node.style.filter = 'none';
                        
                        // Remove tooltip
                        const tooltip = document.querySelector('.node-tooltip');
                        if (tooltip) {
                            document.body.removeChild(tooltip);
                        }
                    }
                });
            });
        }

        function createTooltip(node) {
            const nodeId = node.id;
            const tooltips = {
                'node-start': 'システム処理開始点',
                'node-input': 'ユーザーからの入力を受け付け',
                'node-validation': '入力データの妥当性をチェック',
                'node-error': 'エラーメッセージを表示',
                'node-dbcheck': 'データベースで重複をチェック',
                'node-duplicate': '重複データのエラー処理',
                'node-save': 'データベースに新規データを保存',
                'node-success': '処理完了・成功'
            };
            
            const tooltipText = tooltips[nodeId];
            if (!tooltipText) return null;
            
            const tooltip = document.createElement('div');
            tooltip.className = 'node-tooltip';
            tooltip.textContent = tooltipText;
            tooltip.style.cssText = `
                position: fixed;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 12px;
                font-weight: 500;
                pointer-events: none;
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            // Position tooltip
            const rect = node.getBoundingClientRect();
            tooltip.style.left = (rect.left + rect.width / 2) + 'px';
            tooltip.style.top = (rect.top - 40) + 'px';
            tooltip.style.transform = 'translateX(-50%)';
            
            setTimeout(() => {
                tooltip.style.opacity = '1';
            }, 10);
            
            return tooltip;
        }

        // Initialize on load
        window.addEventListener('load', () => {
            resetAnimation();
            addInteractiveEffects();
            
            // Auto-play after 1 second
            setTimeout(() => {
                playAnimation();
            }, 1000);
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            const svg = document.getElementById('flowchart');
            const container = svg.parentElement;
            
            // Adjust SVG size based on container
            const containerWidth = container.clientWidth;
            if (containerWidth < 600) {
                svg.style.transform = 'scale(0.8)';
                svg.style.transformOrigin = 'top center';
            } else {
                svg.style.transform = 'scale(1)';
            }
        });
    </script>
</body>
</html>